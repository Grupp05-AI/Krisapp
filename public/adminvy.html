<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – Tips</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 1000px; margin: 40px auto; padding: 0 16px; }
    .filters { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; vertical-align: top; }
    th { text-align:left; background:#fafafa; }
    select, input { font-size:14px; padding:6px; }
    button { padding:6px 10px; cursor:pointer; }
    .pill { padding:2px 8px; border-radius:12px; background:#eef; font-size:12px; }
  </style>
</head>
<body>
  <h1>Admin – inkomna tips</h1>

  <div class="filters">
    <label>Prioritet:
      <select id="f-prio">
        <option value="">Alla</option>
        <option value="3">3 (akut)</option>
        <option value="2">2 (hög)</option>
        <option value="1">1 (medel)</option>
        <option value="0">0 (låg)</option>
      </select>
    </label>
    <label>Kategori:
      <select id="f-cat">
        <option value="">Alla</option>
        <option value="security">security</option>
        <option value="cyber">cyber</option>
        <option value="suspicious">suspicious</option>
        <option value="other">other</option>
      </select>
    </label>
    <label>Status:
      <select id="f-status">
        <option value="">Alla</option>
        <option value="new">new</option>
        <option value="in_progress">in_progress</option>
        <option value="resolved">resolved</option>
        <option value="dismissed">dismissed</option>
      </select>
    </label>
    <button id="reload">Ladda</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>ID</th>
        <th>Tid</th>
        <th>Titel & text</th>
        <th>Prio / Risk / Kategori</th>
        <th>Status & anteckning</th>
        <th>Spara</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p id="msg"></p>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://rvnkbqgblrcvtfgwyepu.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_DRfE4M7EPcKsZo_yQxoszA_uE4j63Hz";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const tbody = document.querySelector('#tbl tbody');
    const msg = document.getElementById('msg');

    async function load() {
      msg.textContent = "Laddar…";
      let q = sb.from('tips').select('*').order('created_at', { ascending:false }).limit(200);

      const fp = document.getElementById('f-prio').value;
      const fc = document.getElementById('f-cat').value;
      const fs = document.getElementById('f-status').value;

      if (fp !== "") q = q.eq('priority', Number(fp));
      if (fc) q = q.eq('category', fc);
      if (fs) q = q.eq('status', fs);

      const { data, error } = await q;
      if (error) { msg.textContent = error.message; return; }

      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.id}</td>
          <td>${new Date(row.created_at).toLocaleString()}</td>
          <td><b>${row.title || '(utan titel)'}</b><br>${row.text || ''}</td>
          <td>
            <div>Prio:
              <select data-k="priority">
                <option ${row.priority===3?'selected':''} value="3">3</option>
                <option ${row.priority===2?'selected':''} value="2">2</option>
                <option ${row.priority===1?'selected':''} value="1">1</option>
                <option ${row.priority===0?'selected':''} value="0">0</option>
              </select>
            </div>
            <div>Risk:
              <input data-k="risk_score" type="number" min="0" max="100" value="${row.risk_score ?? 0}" style="width:80px"/>
            </div>
            <div>Kategori:
              <select data-k="category">
                ${['security','cyber','suspicious','other'].map(c=>`<option ${row.category===c?'selected':''} value="${c}">${c}</option>`).join('')}
              </select>
            </div>
          </td>
          <td>
            <div>Status:
              <select data-k="status">
                ${['new','in_progress','resolved','dismissed'].map(s=>`<option ${row.status===s?'selected':''} value="${s}">${s}</option>`).join('')}
              </select>
            </div>
            <div>Anteckning:
              <input data-k="admin_notes" value="${row.admin_notes ?? ''}" />
            </div>
          </td>
          <td><button data-id="${row.id}">Spara</button></td>
        `;
        tbody.appendChild(tr);

        tr.querySelector('button').addEventListener('click', async () => {
          const payload = {};
          tr.querySelectorAll('[data-k]').forEach(el => {
            const k = el.getAttribute('data-k');
            payload[k] = (k==='priority'||k==='risk_score') ? Number(el.value) : el.value;
          });
          const { error } = await sb.from('tips').update(payload).eq('id', row.id).select();
          msg.textContent = error ? ('Fel: '+error.message) : ('Sparat #'+row.id);
        });
      });

      msg.textContent = `Visa ${data.length} rader`;
    }

    document.getElementById('reload').addEventListener('click', load);
    document.getElementById('f-prio').addEventListener('change', load);
    document.getElementById('f-cat').addEventListener('change', load);
    document.getElementById('f-status').addEventListener('change', load);

    load();
  </script>
</body>
</html>
